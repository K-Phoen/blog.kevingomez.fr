<!DOCTYPE html>
<html class="no-js" lang="en-us" dir="ltr"><head prefix="og: http://ogp.me/ns#">
    <meta charset="utf-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Kévin Gomez" />

    <title>RulerZ, specifications and Symfony are in a boat &mdash; Kévin Gomez</title>

    <meta name="description" content="I already introduced RulerZ and the reasoning behind it. This time I&amp;rsquo;ll showcase its integration with Symfony and the Form Component.">

    <meta property="og:title" content="RulerZ, specifications and Symfony are in a boat" />
<meta property="og:description" content="I already introduced [RulerZ and the reasoning behind it](/2015/02/07/on-taming-repository-classes-in-doctrine-among-other-things/). This time I&#39;ll showcase its integration with Symfony and the Form Component." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/2015/03/14/rulerz-specifications-and-symfony-are-in-a-boat/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2015-03-14T00:00:00+00:00" />


    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="RulerZ, specifications and Symfony are in a boat"/>
<meta name="twitter:description" content="I already introduced [RulerZ and the reasoning behind it](/2015/02/07/on-taming-repository-classes-in-doctrine-among-other-things/). This time I&#39;ll showcase its integration with Symfony and the Form Component."/>
<meta name="twitter:site" content="@KPhoen"/>


    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro" />

    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css">
    
    <link rel="stylesheet" href="/css/blog.min.ce0d2d85b6847840515d024b986cdd791b58342541d856834b726c471f201776.css">

    </head>
<body>
<div id="layout" class="pure-g"><div class="sidebar pure-u-1">
    <div class="header">
        <h1 class="brand-title">
            <a href="/">Kévin Gomez</a>
        </h1>
        <h2 class="brand-tagline">I can git now.</h2>

        <nav class="nav">
            <ul class="nav-list">
                
                <li class="nav-item">
                    <a class="pure-button" href="/bookshelf/">Bookshelf</a>
                </li>
                
                <li class="nav-item">
                    <a class="pure-button" href="/talks/">Talks</a>
                </li>
                
                <li class="nav-item">
                    <a class="pure-button" href="/about-me/">About me</a>
                </li>
                
            </ul>
        </nav>
    </div>
</div>
<div class="pure-u-1">
        <div class="content">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
        <h1 itemprop="headline">
            
            <a href="/2015/03/14/rulerz-specifications-and-symfony-are-in-a-boat/">RulerZ, specifications and Symfony are in a boat</a>
        </h1>

        <span class="post-meta">
            <meta itemprop="inLanguage" content="en-us" />
            <time pubdate="pubdate" datetime="2015-03-14T00:00:00+01:00">
                <meta itemprop="datePublished" content="2015-03-14T00:00:00+01:00" />
                14 March 2015
            </time>
            —
            <span class="reading-time" title="Estimated reading time">
                
                    ~5 minutes
                
            </span>
        </span>
    </header>

    
    <section class="shortcuts">
        <p><span class="label radius">Jump to:</span> <a href="#tl-dr">TL;DR</a></p>
    </section>
    

    <section class="post-body" itemprop="articleBody">
        <p>In <a href="http://blog.kevingomez.fr/2015/02/07/on-taming-repository-classes-in-doctrine-among-other-things/">my previous post</a>,
I tried to answer the following question: <strong>how do you keep your Doctrine
repositories from growing exponentially</strong>?
Long story short, I came up with a generic solution based on the
<a href="http://en.wikipedia.org/wiki/Specification_pattern">Specification pattern</a> that
essentially <strong>abstracts and simplifies</strong> the way we write and compose <strong>queries</strong>.
And the best part is that it works with Doctrine but also with any other
data-source.</p>
<p><strong><a href="https://github.com/K-Phoen/rulerz">RulerZ</a> was born</strong>.</p>
<p>Of course, there was a real need behind my previous question. For one of my
current projects, I wanted to be able to switch from one data-source to another.
My application would use Doctrine in development and production environment but
for tests I wanted my data to live in memory.</p>
<p>First thing first, I needed to be able to <strong>manipulate</strong> my <strong>data</strong>.</p>
<p>To achieve that, I defined a <code>CompanyRepository</code> interface — it&rsquo;s a
small project that mainly deals with <em>companies</em> — and wrote two classes
implementing it: one using Doctrine and another one storing my objects in memory.</p>
<p>In the beginning, I only needed to save a company and retrieve it by it&rsquo;s slug
so both implementations were simple and it all worked as expected. The real
issue came when I started to implement a search engine. For each new search
criteria, I had to update two classes and implement the same criteria twice.</p>
<p>At this point, my repositories looked like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1</span><span><span style="color:#c678dd">interface</span> <span style="color:#e06c75">CompanyRepository</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2</span><span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3</span><span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">function</span> <span style="color:#61afef;font-weight:bold">save</span>(<span style="color:#e06c75">Company</span> <span style="color:#e06c75">$company</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4</span><span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">function</span> <span style="color:#61afef;font-weight:bold">find</span>(<span style="color:#e06c75">$slug</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5</span><span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">function</span> <span style="color:#61afef;font-weight:bold">search</span>(<span style="color:#c678dd">array</span> <span style="color:#e06c75">$criteria</span> <span style="color:#56b6c2">=</span> []);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8</span><span><span style="color:#c678dd">class</span> <span style="color:#e5c07b">DoctrineCompanyRepository</span> <span style="color:#c678dd">extends</span> <span style="color:#e06c75">EntityRepository</span> <span style="color:#c678dd">implements</span> <span style="color:#e06c75">CompanyRepository</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9</span><span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10</span><span>    <span style="color:#7f848e">// ...
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11</span><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12</span><span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">function</span> <span style="color:#61afef;font-weight:bold">search</span>(<span style="color:#c678dd">array</span> <span style="color:#e06c75">$criteria</span> <span style="color:#56b6c2">=</span> [])
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13</span><span>    {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14</span><span>        <span style="color:#e06c75">$qb</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">$this</span><span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">createQueryBuilder</span>(<span style="color:#98c379">&#39;c&#39;</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">15</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">16</span><span>        <span style="color:#c678dd">if</span> (<span style="color:#56b6c2">!</span><span style="color:#c678dd">empty</span>(<span style="color:#e06c75">$criteria</span>[<span style="color:#98c379">&#39;name&#39;</span>])) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">17</span><span>            <span style="color:#e06c75">$qb</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">18</span><span>                <span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">andWhere</span>(<span style="color:#98c379">&#39;c.name LIKE :name&#39;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">19</span><span>                <span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">setParameter</span>(<span style="color:#98c379">&#39;name&#39;</span>, <span style="color:#e06c75">sprintf</span>(<span style="color:#98c379">&#39;%%%s%%&#39;</span>, <span style="color:#e06c75">$criteria</span>[<span style="color:#98c379">&#39;name&#39;</span>]));
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">20</span><span>        }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">21</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">22</span><span>        <span style="color:#7f848e">// other criteria
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">23</span><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">24</span><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">$qb</span><span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">getQuery</span>()<span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">getResult</span>();
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">25</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">26</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">27</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">28</span><span><span style="color:#c678dd">class</span> <span style="color:#e5c07b">InMemoryCompanyRepository</span> <span style="color:#c678dd">implements</span> <span style="color:#e06c75">CompanyRepository</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">29</span><span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">30</span><span>    <span style="color:#7f848e">// ...
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">31</span><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">32</span><span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">function</span> <span style="color:#61afef;font-weight:bold">search</span>(<span style="color:#c678dd">array</span> <span style="color:#e06c75">$criteria</span> <span style="color:#56b6c2">=</span> [])
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">33</span><span>    {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">34</span><span>        <span style="color:#e06c75">$companies</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">$this</span><span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">companies</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">35</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">36</span><span>        <span style="color:#c678dd">if</span> (<span style="color:#56b6c2">!</span><span style="color:#c678dd">empty</span>(<span style="color:#e06c75">$criteria</span>[<span style="color:#98c379">&#39;name&#39;</span>])) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">37</span><span>            <span style="color:#e06c75">$companies</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">array_filter</span>(<span style="color:#e06c75">$companies</span>, <span style="color:#c678dd">function</span>(<span style="color:#e06c75">$company</span>) <span style="color:#c678dd">use</span> (<span style="color:#e06c75">$criteria</span>) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">38</span><span>                <span style="color:#c678dd">return</span> <span style="color:#e06c75">stripos</span>(<span style="color:#e06c75">strtolower</span>(<span style="color:#e06c75">$company</span><span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">getName</span>()), <span style="color:#e06c75">strtolower</span>(<span style="color:#e06c75">$criteria</span>[<span style="color:#98c379">&#39;name&#39;</span>])) <span style="color:#56b6c2">!==</span> <span style="color:#c678dd">false</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">39</span><span>            });
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">40</span><span>        }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">41</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">42</span><span>        <span style="color:#7f848e">// other criteria
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">43</span><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">44</span><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">$companies</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">45</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">46</span><span>}
</span></span></code></pre></div><p>The first issue is that my <code>CompanyRepository::search(array $criteria)</code>
method violates the <a href="http://en.wikipedia.org/wiki/Open/closed_principle">open/closed principle</a>.
This is solved by replacing the <code>$criteria</code> parameter by <a href="http://en.wikipedia.org/wiki/Specification_pattern">specifications</a>.
Each specification representing a single search criteria.</p>
<p>The second issue is that with <em>&ldquo;classic&rdquo;</em> specifications, the same specification
can&rsquo;t be used to filter data from several data-sources. We saw that with RulerZ,
this <a href="http://blog.kevingomez.fr/2015/02/07/on-taming-repository-classes-in-doctrine-among-other-things/">problem is solved</a>.</p>
<p><strong>Using RulerZ</strong>, the two previous repositories can be refactored:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1</span><span><span style="color:#c678dd">interface</span> <span style="color:#e06c75">CompanyRepository</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2</span><span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3</span><span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">function</span> <span style="color:#61afef;font-weight:bold">save</span>(<span style="color:#e06c75">Company</span> <span style="color:#e06c75">$company</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4</span><span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">function</span> <span style="color:#61afef;font-weight:bold">find</span>(<span style="color:#e06c75">$slug</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5</span><span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">function</span> <span style="color:#61afef;font-weight:bold">matchingSpec</span>(<span style="color:#e06c75">Specification</span> <span style="color:#e06c75">$spec</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8</span><span><span style="color:#c678dd">class</span> <span style="color:#e5c07b">DoctrineCompanyRepository</span> <span style="color:#c678dd">extends</span> <span style="color:#e06c75">EntityRepository</span> <span style="color:#c678dd">implements</span> <span style="color:#e06c75">CompanyRepository</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9</span><span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10</span><span>    <span style="color:#7f848e">// ...
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11</span><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12</span><span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">function</span> <span style="color:#61afef;font-weight:bold">matchingSpec</span>(<span style="color:#e06c75">Specification</span> <span style="color:#e06c75">$spec</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13</span><span>    {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14</span><span>        <span style="color:#e06c75">$qb</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">$this</span><span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">createQueryBuilder</span>(<span style="color:#98c379">&#39;c&#39;</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">15</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">16</span><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">$this</span><span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">rulerz</span><span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">filterSpec</span>(<span style="color:#e06c75">$qb</span>, <span style="color:#e06c75">$spec</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">17</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">18</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">19</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">20</span><span><span style="color:#c678dd">class</span> <span style="color:#e5c07b">InMemoryCompanyRepository</span> <span style="color:#c678dd">implements</span> <span style="color:#e06c75">CompanyRepository</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">21</span><span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">22</span><span>    <span style="color:#c678dd">private</span> <span style="color:#e06c75">$companies</span> <span style="color:#56b6c2">=</span> [];
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">23</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">24</span><span>    <span style="color:#7f848e">// ...
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">25</span><span><span style="color:#7f848e"></span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">26</span><span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">function</span> <span style="color:#61afef;font-weight:bold">matchingSpec</span>(<span style="color:#e06c75">Specification</span> <span style="color:#e06c75">$spec</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">27</span><span>    {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">28</span><span>        <span style="color:#c678dd">return</span> <span style="color:#e06c75">$this</span><span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">rulerz</span><span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">filterSpec</span>(<span style="color:#e06c75">$this</span><span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">companies</span>, <span style="color:#e06c75">$spec</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">29</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">30</span><span>}
</span></span></code></pre></div><p>You probably noticed a <small>not so</small> subtle difference compared to the
old repositories: I rely on RulerZ so I have to inject it somehow. Lucky me,
I&rsquo;m working on a Symfony application and there is <a href="https://github.com/K-Phoen/RulerZBundle">a bundle for that</a>!</p>
<p>As <strong>RulerZ</strong> is now properly <strong>integrated into my repositories</strong> and I&rsquo;m able
to query my data, I need to address the <strong>specification-creation issue</strong>.
Remember, I was trying to implement a search engine so <strong>how do I map a search</strong>
as expressed by a user (through a form for instance) <strong>to a specification</strong>?</p>
<p>The idea here is to map a user input — a search criteria — to a specification.
A string (or a scalar) to an object. Using Symfony Form component. Looks a lot
like a <strong><a href="http://symfony.com/doc/current/cookbook/form/data_transformers.html">DataTransformer</a></strong>
don&rsquo;t you think?</p>
<p>With that in mind, I wrote the following form type:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1</span><span><span style="color:#c678dd">class</span> <span style="color:#e5c07b">CompanySearchType</span> <span style="color:#c678dd">extends</span> <span style="color:#e06c75">AbstractType</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2</span><span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3</span><span>    <span style="color:#c678dd">public</span> <span style="color:#c678dd">function</span> <span style="color:#61afef;font-weight:bold">buildForm</span>(<span style="color:#e06c75">FormBuilderInterface</span> <span style="color:#e06c75">$builder</span>, <span style="color:#c678dd">array</span> <span style="color:#e06c75">$options</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4</span><span>    {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5</span><span>        <span style="color:#e06c75">$terms</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">$builder</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6</span><span>            <span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">create</span>(<span style="color:#98c379">&#39;who&#39;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7</span><span>            <span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">addModelTransformer</span>(
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8</span><span>                <span style="color:#c678dd">new</span> <span style="color:#e06c75">SpecToStringTransformer</span>(<span style="color:#e06c75">Spec\CompanyName</span><span style="color:#56b6c2">::</span><span style="color:#e06c75">class</span>, <span style="color:#98c379">&#39;terms&#39;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9</span><span>            );
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11</span><span>        <span style="color:#e06c75">$location</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">$builder</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12</span><span>            <span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">create</span>(<span style="color:#98c379">&#39;where&#39;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13</span><span>            <span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">addModelTransformer</span>(
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14</span><span>                <span style="color:#c678dd">new</span> <span style="color:#e06c75">SpecToStringTransformer</span>(<span style="color:#e06c75">Spec\CompanyLocation</span><span style="color:#56b6c2">::</span><span style="color:#e06c75">class</span>, <span style="color:#98c379">&#39;location&#39;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">15</span><span>            );
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">16</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">17</span><span>        <span style="color:#e06c75">$builder</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">18</span><span>            <span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">add</span>(<span style="color:#e06c75">$terms</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">19</span><span>            <span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">add</span>(<span style="color:#e06c75">$location</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">20</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">21</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">22</span><span>    <span style="color:#7f848e">// ...
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">23</span><span><span style="color:#7f848e"></span>}
</span></span></code></pre></div><p>The form type itself is pretty straightforward, the only thing to notice is the
usage of <code>SpecToStringTransformer</code>. It takes two parameters: the
<abbr title="Fully-Qualified Class Name">FQCN</abbr> of the specification to
build and a property in this specification containing the value.
The transformer&rsquo;s code itself isn&rsquo;t really important but if you really want to
read it, it&rsquo;s available as <a href="https://gist.github.com/K-Phoen/5c1b06a864d063c1ee4e#file-data_transformer-php">a gist</a>.</p>
<p>What&rsquo;s important is that combining the Form Component, a simple transformer and
RulerZ leads to really simple controllers:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 1</span><span><span style="color:#c678dd">public</span> <span style="color:#c678dd">function</span> <span style="color:#61afef;font-weight:bold">searchAction</span>(<span style="color:#e06c75">Request</span> <span style="color:#e06c75">$request</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 2</span><span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 3</span><span>    <span style="color:#e06c75">$results</span> <span style="color:#56b6c2">=</span> [];
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 4</span><span>    <span style="color:#e06c75">$form</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">$this</span><span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">formFactory</span><span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">create</span>(<span style="color:#98c379">&#39;company_search&#39;</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 5</span><span>    <span style="color:#e06c75">$form</span><span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">handleRequest</span>(<span style="color:#e06c75">$request</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 6</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 7</span><span>    <span style="color:#c678dd">if</span> (<span style="color:#e06c75">$form</span><span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">isValid</span>()) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 8</span><span>        <span style="color:#e06c75">$spec</span> <span style="color:#56b6c2">=</span> <span style="color:#c678dd">new</span> <span style="color:#e06c75">Spec\AndX</span>(<span style="color:#e06c75">array_merge</span>(        <span style="color:#7f848e">// aggregate specifications
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f"> 9</span><span><span style="color:#7f848e"></span>            <span style="color:#e06c75">array_filter</span>(<span style="color:#e06c75">$form</span><span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">getData</span>()),       <span style="color:#7f848e">// remove empty fields/specs
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">10</span><span><span style="color:#7f848e"></span>            <span style="color:#c678dd">array</span>(<span style="color:#c678dd">new</span> <span style="color:#e06c75">AppSpec\CompanyPublished</span>()) <span style="color:#7f848e">// only display published companies
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">11</span><span><span style="color:#7f848e"></span>        ));
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">12</span><span>        <span style="color:#e06c75">$results</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">$this</span><span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">companyRepository</span><span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">matchingSpec</span>(<span style="color:#e06c75">$spec</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">13</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">14</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">15</span><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">$this</span><span style="color:#56b6c2">-&gt;</span><span style="color:#e06c75">render</span>(<span style="color:#98c379">&#39;...&#39;</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#55595f">16</span><span>}
</span></span></code></pre></div><p>Do you see the magic? A classic <strong>form type</strong> can automatically <strong>build
specifications</strong> that can be used to <strong>retrieve data</strong> from a Doctrine repository,
an in-memory repository or virtually any other data-source.
Also, adding new search criteria boils down to writing its specification and
adding a new field in the form type. How cool is that?</p>

    </section>

    
    <section class="post-tl-dr">
        <h2 id="tl-dr">TL;DR</h2>
        <p>Using RulerZ and Symfony you can:</p>
<ul>
<li>use specification objects inside Doctrine repositories to query your data ; * make the Form component build specification objects for you.</li>
</ul>

    </section>
    
</article>
<div class="footer">
    <div class="pure-menu pure-menu-horizontal">
        <ul>
            <li class="pure-menu-item"><a href="https://twitter.com/KPhoen/" class="pure-menu-link">Twitter</a></li>
            <li class="pure-menu-item"><a href="https://github.com/K-Phoen/" class="pure-menu-link">GitHub</a></li>
            <li class="pure-menu-item"><a href="https://www.linkedin.com/in/kevingomez/" class="pure-menu-link">LinkedIn</a></li>
        </ul>
    </div>
</div>
</div>
    </div>
</div>


</body>
</html>
