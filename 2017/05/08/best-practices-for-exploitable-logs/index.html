<!DOCTYPE html>
<html class="no-js" lang="en-us" dir="ltr"><head prefix="og: http://ogp.me/ns#">
    <meta charset="utf-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Kévin Gomez" />

    <title>Best practices for exploitable logs &mdash; Kévin Gomez</title>

    <meta name="description" content="« What to log? » — That&amp;rsquo;s the question I often ask myself when I launch new projects or work on existing applications.
And by « what », I mean which events should be logged? Using which format? Where should they be sent?
To answer these questions, we need to ask ourselves why do we need logs in the first place?
">

    <meta property="og:title" content="Best practices for exploitable logs" />
<meta property="og:description" content="« What to log? » — That&rsquo;s the question I often ask myself when I launch new
projects or work on existing applications.

And by « what », I mean which events should be logged? Using which format? Where
should they be sent?

To answer these questions, we need to ask ourselves why do we need logs in the
first place?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/2017/05/08/best-practices-for-exploitable-logs/" />
<meta property="article:published_time" content="2017-05-08T00:00:00+00:00" />


    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Best practices for exploitable logs"/>
<meta name="twitter:description" content="« What to log? » — That&rsquo;s the question I often ask myself when I launch new
projects or work on existing applications.

And by « what », I mean which events should be logged? Using which format? Where
should they be sent?

To answer these questions, we need to ask ourselves why do we need logs in the
first place?"/>
<meta name="twitter:site" content="@KPhoen"/>


    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro" />

    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css">
    
    <link rel="stylesheet" href="/css/blog.min.3cb1c5546ad2231369059c2e3e7672679cd1a99af4be7ed0c73f15ba83148464.css">

    </head>
<body>
<div id="layout" class="pure-g"><div class="sidebar pure-u-1">
    <div class="header">
        <h1 class="brand-title">
            <a href="/">Kévin Gomez</a>
        </h1>
        <h2 class="brand-tagline">I can git now.</h2>

        <nav class="nav">
            <ul class="nav-list">
                
                <li class="nav-item">
                    <a class="pure-button" href="/bookshelf/">Bookshelf</a>
                </li>
                
                <li class="nav-item">
                    <a class="pure-button" href="/talks/">Talks</a>
                </li>
                
                <li class="nav-item">
                    <a class="pure-button" href="/about-me/">About me</a>
                </li>
                
            </ul>
        </nav>
    </div>
</div>
<div class="pure-u-1">
        <div class="content">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
        <h1 itemprop="headline">
            
            <a href="/2017/05/08/best-practices-for-exploitable-logs/">Best practices for exploitable logs</a>
        </h1>

        <span class="post-meta">
            <meta itemprop="inLanguage" content="en-us" />
            <time pubdate="pubdate" datetime="2017-05-08T00:00:00+01:00">
                <meta itemprop="datePublished" content="2017-05-08T00:00:00+01:00" />
                8 May 2017
            </time>
            —
            <span class="reading-time" title="Estimated reading time">
                
                    ~6 minutes
                
            </span>
        </span>
    </header>

    
    <section class="shortcuts">
        <p><span class="label radius">Jump to:</span> <a href="#tl-dr">TL;DR</a></p>
    </section>
    

    <section class="post-body" itemprop="articleBody">
        <p>« <strong>What to log?</strong> » — That&rsquo;s the question I often ask myself when I launch new
projects or work on existing applications.</p>

<p>And by « what », I mean which events should be logged? Using which format? Where
should they be sent?</p>

<p>To answer these questions, we need to ask ourselves why do we need logs in the
first place?</p>

<h2 id="determine-your-logging-strategy">Determine your logging strategy</h2>

<p>Logging everything would be counter-productive as we would end up with too much
data to search and the important information would probably be hidden in
non-essential logs.</p>

<p>Therefore, the first step is to determine what your logs will be used for.</p>

<p>Common logging strategies include:</p>

<ul>
<li><strong>performance and resources</strong>: memory consumption, CPU/IO/network usage,
external API calls and their response times, …
Helps to monitor, debug and improve the general performance of the system.</li>
<li><strong>errors</strong>: exceptions, warnings, unexpected responses, …
Helps detecting and troubleshooting issues with the system or its environment.</li>
<li><strong>user actions</strong>: actions performed by your users.
Useful to help users when they come across an issue.</li>
<li><strong>business metrics</strong>: business-related events.
Can be used as a <em>poor man&rsquo;s BI tool</em>.</li>
</ul>

<p>That&rsquo;s why the logging strategy employed in these applications is
<em>&ldquo;user actions&rdquo;-oriented</em>.</p>

<h2 id="log-log-log">Log, log, log</h2>

<p>Now that your logging strategy is identified, <strong>be sure that all the relevant
events are logged</strong>.</p>

<p>Most of the time, I need logs to help me debug a running system. Be it an API
that returns unexpected or incorrect responses or an e-commerce platform failing
randomly during the checkout process.</p>

<p>In this case, <strong>error logs are not enough</strong> to know what your users were doing
before the system failed. That&rsquo;s why I add logs for every significant action
performed by the user. I see these logs as &ldquo;checkpoints&rdquo; like we would find in
video games: they allow me to see what the user was doing before it all went
wrong.</p>

<h2 id="logs-and-context">Logs and context</h2>

<p>For your logs to be useful, they have to vehiculate enough data.</p>

<p>Let&rsquo;s say that our system produces a log each time a user signs in. Would you
rather produce something like this?</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">User logged in.</code></pre></div>
<p>Or like this?</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2016</span>-02-03T10:04:51.965Z<span style="color:#ce5c00;font-weight:bold">]</span> User <span style="color:#4e9a06">&#34;K-Phoen&#34;</span> logged in after <span style="color:#0000cf;font-weight:bold">2</span> attempts.</code></pre></div>
<p>That&rsquo;s right, the last one is more useful and gives you a better understanding
of what happened.</p>

<p>As a rule of thumb, I try to include as much context as possible in my logs. If
a user is logged in, I join its identifier. If an order was being processed, I
give its reference. <strong>If an error occurs</strong>, I include all the previous details
to which I <strong>join the error message and its backtrace</strong>.</p>

<p>You don&rsquo;t know what kind of nasty bugs your users will encounter so do yourself
a favor: <strong>be proactive and include as much context as you can</strong>.</p>

<p>Including a date at the beginning of each log entry is also a must-have.</p>

<p><strong>Bonus point</strong> for using a standard format for the date (ISO 8601 is fine) and
including the timezone.</p>

<p>Be sure that you <strong>do not log anything secret</strong>, be it in the log message itself
or in the context. I particularly think of passwords, API secrets, …</p>

<h2 id="logs-should-be-machine-readable-and-human-understandable">Logs should be machine readable and human understandable</h2>

<p>My previous example was far from being perfect.</p>

<p>Even if the log message was quite descriptive and provided some context, the log
itself would have been &ldquo;hard&rdquo; to process by a program.
For instance, extracting the context would have required the use of regular
expressions… which is not exactly great for performance.</p>

<p><strong>Logs should be written in plain text</strong> so that both humans and machines can
read and process them.</p>

<p>If you have to log additional, structured data in addition to the event
description, use a format like JSON:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2016</span>-02-03T10:04:51.965Z<span style="color:#ce5c00;font-weight:bold">]</span> User <span style="color:#ce5c00;font-weight:bold">{</span>login<span style="color:#ce5c00;font-weight:bold">}</span> logged in after <span style="color:#ce5c00;font-weight:bold">{</span>attempts_count<span style="color:#ce5c00;font-weight:bold">}</span> attempts -- <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;login&#34;</span>: <span style="color:#4e9a06">&#34;K-Phoen&#34;</span>, <span style="color:#4e9a06">&#34;email&#34;</span>: <span style="color:#4e9a06">&#34;contact@kevingomez.fr&#34;</span>, <span style="color:#4e9a06">&#34;attempts_count&#34;</span>: <span style="color:#0000cf;font-weight:bold">2</span>, <span style="color:#4e9a06">&#34;authentication_mode&#34;</span>: <span style="color:#4e9a06">&#34;http_basic&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span></code></pre></div>
<p>The log entry is as readable as before but includes more context and remains
easily indexable by a machine.</p>

<p><strong>Bonus point</strong> for using placeholders in your log descriptions can ease logs
aggregation done by tools such as Sentry or Airbrake.</p>

<p>Be sure to <strong>avoid multi-line logs</strong> as they make the logs processing more
complex. Consider breaking multi-line events into separate events.</p>

<h2 id="categorize-and-correlate-events">Categorize and correlate events</h2>

<p>Speaking about events processing: categorizing events is a great way to help
logs exploration.</p>

<p>The first thing to do is to use <strong>the appropriate level</strong> when logging an event.
Which level to use is ultimately the developer&rsquo;s decision but the available
levels and their meaning is defined in <a href="https://tools.ietf.org/html/rfc5424#page-11">the RFC 5424</a>
(the one describing the Syslog protocol).</p>

<p>The minimum log level to choose in production depends on the application&rsquo;s
stability. I would switch to DEBUG level for new or unstable applications
whereas for stable ones I would prefer INFO.</p>

<p>In addition to log levels, I like to <strong>identify the subsystems emitting the
events</strong> by including its name in the log entry:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2016</span>-02-03T10:04:51.965Z<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>security<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> User <span style="color:#ce5c00;font-weight:bold">{</span>login<span style="color:#ce5c00;font-weight:bold">}</span> logged in after <span style="color:#ce5c00;font-weight:bold">{</span>attempts_count<span style="color:#ce5c00;font-weight:bold">}</span> attempts -- <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;login&#34;</span>: <span style="color:#4e9a06">&#34;K-Phoen&#34;</span>, <span style="color:#4e9a06">&#34;email&#34;</span>: <span style="color:#4e9a06">&#34;contact@kevingomez.fr&#34;</span>, <span style="color:#4e9a06">&#34;attempts_count&#34;</span>: <span style="color:#0000cf;font-weight:bold">2</span>, <span style="color:#4e9a06">&#34;authentication_mode&#34;</span>: <span style="color:#4e9a06">&#34;http_basic&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span></code></pre></div>
<p>Using the appropriate log level in addition to a subsystem identifier allows us
to quickly obtain information on a specific event that happened in the
application.</p>

<p>But so far, we do not have anything to link these event together or, for
instance, to retrieve all the events associated to the same request.
To achieve that, a <em>request identifier</em> should be generated as early as possible
in the request lifecyle and included in all the log events.</p>

<p>This identifier can even be generated by Nginx if you want to correlate your
access logs and your application logs.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2016</span>-02-03T10:04:51.965Z<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>routing<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> Request matched route <span style="color:#ce5c00;font-weight:bold">{</span>route<span style="color:#ce5c00;font-weight:bold">}</span> -- <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;route&#34;</span>: <span style="color:#4e9a06">&#34;login&#34;</span>, <span style="color:#4e9a06">&#34;method&#34;</span>: <span style="color:#4e9a06">&#34;GET&#34;</span>, <span style="color:#4e9a06">&#34;controller&#34;</span>: <span style="color:#4e9a06">&#34;…&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;request_id&#34;</span>: <span style="color:#4e9a06">&#34;7d5e8092-a13d-45b8-adb4-b26c18806825&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2016</span>-02-03T10:04:51.965Z<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>security<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> User <span style="color:#ce5c00;font-weight:bold">{</span>login<span style="color:#ce5c00;font-weight:bold">}</span> logged in after <span style="color:#ce5c00;font-weight:bold">{</span>attempts_count<span style="color:#ce5c00;font-weight:bold">}</span> attempts -- <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;login&#34;</span>: <span style="color:#4e9a06">&#34;K-Phoen&#34;</span>, <span style="color:#4e9a06">&#34;email&#34;</span>: <span style="color:#4e9a06">&#34;contact@kevingomez.fr&#34;</span>, <span style="color:#4e9a06">&#34;attempts_count&#34;</span>: <span style="color:#0000cf;font-weight:bold">2</span>, <span style="color:#4e9a06">&#34;authentication_mode&#34;</span>: <span style="color:#4e9a06">&#34;http_basic&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;request_id&#34;</span>: <span style="color:#4e9a06">&#34;7d5e8092-a13d-45b8-adb4-b26c18806825&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span></code></pre></div>
<p>I often include two sets of metadata in my log entries:</p>

<ul>
<li>the first represents a <em>log context</em> and is associated to the event itself ;</li>
<li>the other represents <em>extra metadata</em> automatically added to any event
emitted by the application.</li>
</ul>

<p>These two set of information are kept separated to avoid collisions.</p>

<h2 id="infrastructure-considerations">Infrastructure considerations</h2>

<p>In this blog post, I just wanted to lay out a few practices that I consider
useful in regards to our logging strategies.
How logs are used and with which tools is not a subject that I tried to cover
here. That&rsquo;s why you did not find any mention to projects such as Kibana,
Splunk, Graylog, …</p>

<p>That being said, I wanted to introduce two practices that are more related to
infrastructure considerations than applicative ones.</p>

<p>The first concerns logs storage on the applicative server: <strong>ensure that your log
files are rotated, compressed and eventually removed</strong>.</p>

<p>If you do not log to a file but to some kind of log server like <a href="https://syslog-ng.org/">Syslog</a>
or a forwarder like <a href="https://www.elastic.co/products/beats">Beats</a>, be sure that
these agents are running locally, directly on the application server. You do
not want to loose your logs in case of a network failure!</p>
    </section>

    
    <section class="post-tl-dr">
        <h2 id="tl-dr">TL;DR</h2>
        <ul>
<li>choose a logging strategy: are you more interested by performance, user actions or business metrics?</li>
<li>make sure that all relevant events are logged, not only the errors!</li>
<li>add some context to your events. Customer identifier? Order reference? Anything that might prove useful is appreciated.</li>
<li>include dates in a standard format to give make the events chronology explicit.</li>
<li>ensure that your logs follow a precise, textual format. It should be easily understandable by both humans and machines.</li>
<li>categorize and correlate logs using log levels, subsystems identifiers and request identifiers.</li>
</ul>
    </section>
    
</article>
<div class="footer">
    <div class="pure-menu pure-menu-horizontal">
        <ul>
            <li class="pure-menu-item"><a href="https://twitter.com/KPhoen/" class="pure-menu-link">Twitter</a></li>
            <li class="pure-menu-item"><a href="https://github.com/K-Phoen/" class="pure-menu-link">GitHub</a></li>
            <li class="pure-menu-item"><a href="https://www.linkedin.com/in/kevingomez/" class="pure-menu-link">LinkedIn</a></li>
        </ul>
    </div>
</div>
</div>
    </div>
</div>
</body>
</html>
